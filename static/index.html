<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Microphone Stream</title>
</head>
<body>
    <h1>WebRTC Microphone Stream</h1>
    <button id="startButton">Start Recording</button>

    <script>
        const startButton = document.getElementById('startButton');
        const serverUrl = "ws://192.168.0.135:1010/ws"; // Адрес WebSocket-сервера

        let ws;
        let pc;
        let stream;

        startButton.addEventListener('click', async () => {
            // Запрашиваем доступ к микрофону
            const mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream = mediaStream;

            // Создаем WebRTC PeerConnection
            pc = new RTCPeerConnection();

            // Добавляем аудиотрек с микрофона
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            // Подключаемся к WebSocket серверу
            ws = new WebSocket(serverUrl);
            ws.onopen = async () => {
                console.log("Connected to server");

                // Отправляем SDP-предложение серверу
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));

                // Получаем SDP-ответ от сервера
                ws.onmessage = async (message) => {
                    const data = JSON.parse(message.data);

                    if (data.type === 'answer') {
                        const answer = new RTCSessionDescription({ type: 'answer', sdp: data.sdp });
                        await pc.setRemoteDescription(answer);
                    } else if (data.type === 'icecandidate') {
                        // Отправляем ICE кандидат
                        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                };
            };

            // Обработка ICE кандидатов
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'icecandidate', candidate: event.candidate }));
                }
            };
        });
    </script>
</body>
</html>
